<!DOCTYPE html>
<html lang="en">
<head>
  <title>Running Libvirt (KVM) in Cirrus CI</title>
  <meta name="description" content="Orange Sun | Posts | Vitaly Potyarkin | 2020-02-25">
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="origin">
  <meta name="generator" content="Pelican">
  <link href="https://potyarkin.ml/posts/2020/running-libvirt-kvm-in-cirrus-ci/" rel="canonical">
<link href="https://potyarkin.ml/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Orange Sun Full Atom Feed" />
<link href="https://potyarkin.ml/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Orange Sun Full RSS Feed" />
  <link href="https://potyarkin.ml/theme/css/style.css?cache=02dd7414fa33ed6c49fd4572cc2b337a432cbd334508e1d2a331c68a8b0c32a3" type="text/css" rel="stylesheet">
  <link href="https://potyarkin.ml/theme/css/fonts.css?cache=32c843bb3ce96eb9fb92f48c7a63dc133ab32e0d267a2e1453199c23403d5cd0" type="text/css" rel="stylesheet">
  <link href="https://potyarkin.ml/theme/css/codecolor/bleak.css?cache=4793611eaa86c9638927c57ac8d9995c5f7ca18d9ffed3721467cf3ef61b5e8e" type="text/css" rel="stylesheet">
    <link href="https://potyarkin.ml/static/custom.css" type="text/css" rel="stylesheet">
</head>
<body class="pelican-article">
<nav id="menu">
  <a href="#" class="close button">Close</a>
  <a href="#menu" class="open button">Menu</a>
  <ul class="menu-list">
      <li><a href="/archive/">Archive</a></li>
      <li><a href="/tags/">Tags</a></li>
      <li><a href="mailto:sio.wtf@gmail.com">Email</a></li>
      <li><a href="https://github.com/sio">Github</a></li>
      <li><a href="/feeds/">feed</a></li>
      <li><a href="/bookmarks/">bookmarks</a></li>
      <li><a href="https://potyarkin.ml/blogroll/">Blogroll</a></li>
  </ul>
</nav>  <header class="page-header">
    <h1>Running Libvirt (KVM) in Cirrus CI</h1>
    <span class="subtitle"><a href="https://potyarkin.ml/">Orange Sun</a> |
<a href="https://potyarkin.ml/posts/">Posts</a> |   <a href="https://potyarkin.ml/">Vitaly Potyarkin</a>
| 2020-02-25
</span>
  </header>
<article class="full"><p>Up until the middle of 2019 it was very unusual to even expect that any CI
service would allow nested virtualization. Those who required such
functionality had to maintain their own CI runners on their own
infrastructure. Things changed when Google Cloud introduced <a href="https://cloud.google.com/compute/docs/instances/enable-nested-virtualization-vm-instances">nested
KVM</a> support.</p>
<p><a href="https://cirrus-ci.org/">Cirrus CI</a> was probably the first CI service to <a href="https://cirrus-ci.org/guide/linux/#kvm-enabled-privileged-containers">officially
support</a> nested virtualization in free tier. There are reports
that Travis CI currently also provides such feature but no public announcement
has been made yet.</p>
<p>It turns out I was the first person to try using Libvirt in Cirrus CI (I've
even hit a previously unknown <a href="https://github.com/cirruslabs/cirrus-ci-docs/issues/564">bug</a> which was promptly fixed by their staff).
Since the process has some subtle differences to the popular documented use
cases I've decided to describe it here.</p>
<h2 id="hypervisor-environment"><a class="toclink" href="#hypervisor-environment">Hypervisor environment</a></h2>
<p>Cirrus CI uses Docker images as environment for their runners. It
significantly simplifies the setup and enables efficient caching between runs.</p>
<p>Since popular Docker images do not include any hypervisor packages we need to
build our own image. I've decided to add the required packages to Debian base
image. The whole <a href="https://gitlab.com/sio/server_common/-/blob/master/ansible/tests/Dockerfile.host-kvm">Dockerfile</a> is essentially one <code>apt-get</code> statement.</p>
<p>Keep in mind that libvirt package in Debian drops root privileges when
launching <code>qemu-kvm</code>. You'll either need to disable that in
<code>/etc/libvirt/qemu.conf</code> (as I did) or to change permissions for <code>/dev/kvm</code> to
allow access by <code>libvirt-qemu</code> user.</p>
<h2 id="required-system-services"><a class="toclink" href="#required-system-services">Required system services</a></h2>
<p>Default entry point for CI runner is not customizable in Cirrus CI - it's an
agent process that communicates with CI service and sends progress reports you
see in web interface. Because of that no systemd units are started automatically
as it would have been the case on a normal system. More than that, starting
systemd manually also looks impossible.</p>
<p>That means all the daemons required by libvirt must be started manually (see
documentation on <a href="https://cirrus-ci.org/guide/writing-tasks/#background-script-instruction">background_script</a> syntax):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># .cirrus.yml</span><span class="w"></span>
<span class="nt">dbus_background_script</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdir -p /var/run/dbus</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/dbus-daemon --system --nofork --nopidfile</span><span class="w"></span>
<span class="nt">virtlogd_background_script</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/sbin/virtlogd</span><span class="w"></span>
<span class="nt">libvirtd_background_script</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sleep 2 &amp;&amp; /usr/sbin/libvirtd</span><span class="w"></span>
</code></pre></div>

<h2 id="firewall-configuration"><a class="toclink" href="#firewall-configuration">Firewall configuration</a></h2>
<p>Hypervisor kernel is provided as is, and it currently runs legacy iptables
firewall. Trying to use iptables-nft (which is the default in current Debian)
produces a misconfigured guest network that is hard to debug.</p>
<p>That's why we need to tell Debian to use legacy iptables interface across the whole
system:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># .cirrus.yml</span><span class="w"></span>
<span class="nt">iptables_legacy_script</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">update-alternatives --set iptables /usr/sbin/iptables-legacy</span><span class="w"></span>
</code></pre></div>

<h2 id="_1"><a class="toclink" href="#_1">&nbsp;</a></h2>
<p>That's it! Following these steps I was able to execute Libvirt (via
Vagrant-Libvirt, via Molecule) in Cirrus CI environment. <a href="https://gitlab.com/sio/server_common/-/blob/master/.cirrus.yml.j2">Full configuration</a>
is available here, it includes some extra caching steps and many debug
statements that helped me to implement this process in the first place.</p></article>
<nav class="article-tags">
  <a href="https://potyarkin.ml/tags/ci/">ci</a>
  <a href="https://potyarkin.ml/tags/automation/">automation</a>
</nav>
<nav class="neighbors">
  <a class="neighbor neighbor-prev" href="https://potyarkin.ml/posts/2020/cirrus-ci-integration-for-gitlab-projects/">
    <h1>Cirrus CI integration for GitLab projects</h1>
    <p>Cirrus CI is a relatively new hosted CI service that offers several unique features....</p>
  </a>
  <a class="neighbor neighbor-next" href="https://potyarkin.ml/posts/2020/pegatron-cape-7/">
    <h1>Pegatron Cape 7 nettop (thin client)</h1>
    <p>Below are hardware details of an outdated compact computer that had since become...</p>
  </a>
</nav>
<footer class="page-footer">
  <section class="credits">
        <span class="credits-left">
          Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a>
        </span>
        <span class="credits-center">
          <a href="https://potyarkin.ml/">Orange Sun</a>
        </span>
        <span class="credits-right">
          Theme <a href="https://github.com/sio/pelican-smallweb" rel="nofollow">SmallWeb</a>
        </span>
  </section>
</footer></body>
</html>